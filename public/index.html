<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Exchange Rate Dashboard â€” BitLab</title>

<!-- Chart.js + Zoom plugin -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --bitlab-navy: #00134D;
  --bitlab-white: #F6F9FC;
  --glass-bg: rgba(255,255,255,0.75);
  --glass-dark: rgba(8,18,30,0.65);
  --muted: #6b7280;
  --radius: 16px;
  --primary: #0b74ff;
  --primary-dark: #0066cc;
  --success: #10b981;
  --danger: #ef4444;
  --warning: #f59e0b;
  --shadow-sm: 0 2px 8px rgba(0,0,0,0.04);
  --shadow-md: 0 4px 16px rgba(0,0,0,0.08);
  --shadow-lg: 0 8px 32px rgba(0,0,0,0.12);
  --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* dark theme variables */
.bitlab-custom-class-dark-theme {
  --glass-bg: rgba(15,23,42,0.75);
  --bitlab-white: #0f172a;
  --muted: #94a3b8;
  --bitlab-navy: #f1f5f9;
  --shadow-sm: 0 2px 8px rgba(0,0,0,0.3);
  --shadow-md: 0 4px 16px rgba(0,0,0,0.4);
  --shadow-lg: 0 8px 32px rgba(0,0,0,0.5);
}

/* base */
* {
  box-sizing: border-box;
}

html,body{
  height:100%;
  margin:0;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #4facfe 75%, #00f2fe 100%);
  background-size: 400% 400%;
  animation: gradientShift 15s ease infinite;
  font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

@keyframes gradientShift {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

.bitlab-custom-class-dark-theme html,
.bitlab-custom-class-dark-theme body {
  background: linear-gradient(135deg, #1e1b4b 0%, #312e81 25%, #1e293b 50%, #0f172a 75%, #1e1b4b 100%);
  background-size: 400% 400%;
}

.bitlab-custom-class-app{
  margin: 0;
  padding: 24px;
  min-height: 100vh;
  width: 100%;
}

/* header */
.bitlab-custom-class-top{
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 20px;
  margin-bottom: 24px;
  flex-wrap: wrap;
  background: var(--glass-bg);
  backdrop-filter: blur(20px) saturate(180%);
  padding: 20px 24px;
  border-radius: var(--radius);
  box-shadow: var(--shadow-md);
  border: 1px solid rgba(255,255,255,0.2);
}

.bitlab-custom-class-brand{
  display: flex;
  align-items: center;
  gap: 16px;
  flex: 1;
  min-width: 200px;
}

.bitlab-custom-class-logo{
  width: 56px;
  height: 56px;
  border-radius: 14px;
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: 700;
  font-size: 20px;
  box-shadow: 0 8px 24px rgba(11,116,255,0.3);
  transition: var(--transition);
}

.bitlab-custom-class-logo:hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 32px rgba(11,116,255,0.4);
}

.bitlab-custom-class-title{
  font-size: 24px;
  font-weight: 700;
  color: var(--bitlab-navy);
  margin: 0;
  line-height: 1.2;
}

.bitlab-custom-class-sub{
  font-size: 14px;
  color: var(--muted);
  margin-top: 4px;
  line-height: 1.4;
}

/* controls */
.bitlab-custom-class-controls{
  display: flex;
  gap: 12px;
  align-items: center;
  flex-wrap: wrap;
}

.bitlab-custom-class-control-group {
  display: flex;
  align-items: center;
  gap: 8px;
  background: rgba(255,255,255,0.5);
  padding: 6px 12px;
  border-radius: 12px;
  backdrop-filter: blur(10px);
}

.bitlab-custom-class-input{
  padding: 10px 14px;
  border-radius: 12px;
  border: 1px solid rgba(0,0,0,0.1);
  background: rgba(255,255,255,0.9);
  backdrop-filter: blur(10px);
  font-size: 14px;
  transition: var(--transition);
  outline: none;
  font-family: inherit;
}

.bitlab-custom-class-input:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(11,116,255,0.1);
  background: rgba(255,255,255,1);
}

.bitlab-custom-class-input[type="number"] {
  width: 80px;
  text-align: center;
}

.bitlab-custom-class-btn{
  padding: 10px 20px;
  border-radius: 12px;
  border: none;
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
  color: white;
  cursor: pointer;
  font-weight: 600;
  font-size: 14px;
  box-shadow: 0 4px 12px rgba(11,116,255,0.3);
  transition: var(--transition);
  font-family: inherit;
  white-space: nowrap;
}

.bitlab-custom-class-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(11,116,255,0.4);
}

.bitlab-custom-class-btn:active {
  transform: translateY(0);
}

.bitlab-custom-class-btn-secondary {
  background: rgba(255,255,255,0.9);
  color: var(--bitlab-navy);
  box-shadow: var(--shadow-sm);
}

.bitlab-custom-class-btn-secondary:hover {
  background: rgba(255,255,255,1);
  box-shadow: var(--shadow-md);
}

/* layout */
.bitlab-custom-class-grid{
  display: grid;
  grid-template-columns: 380px 1fr;
  gap: 24px;
}

.bitlab-custom-class-side{
  position: relative;
  padding: 24px;
  border-radius: var(--radius);
  background: var(--glass-bg);
  backdrop-filter: blur(20px) saturate(180%);
  box-shadow: var(--shadow-lg);
  border: 1px solid rgba(255,255,255,0.2);
  max-height: calc(100vh - 180px);
  overflow-y: auto;
  scrollbar-width: thin;
  scrollbar-color: rgba(0,0,0,0.2) transparent;
}

.bitlab-custom-class-side::-webkit-scrollbar {
  width: 6px;
}

.bitlab-custom-class-side::-webkit-scrollbar-track {
  background: transparent;
}

.bitlab-custom-class-side::-webkit-scrollbar-thumb {
  background: rgba(0,0,0,0.2);
  border-radius: 3px;
}

.bitlab-custom-class-main{
  padding: 24px;
  border-radius: var(--radius);
  background: var(--glass-bg);
  backdrop-filter: blur(20px) saturate(180%);
  box-shadow: var(--shadow-lg);
  border: 1px solid rgba(255,255,255,0.2);
  display: flex;
  flex-direction: column;
}

.bitlab-custom-class-main-content {
  display: grid;
  grid-template-columns: 1fr 400px;
  gap: 24px;
  flex: 1;
  min-height: 0;
}

/* currency list */
.bitlab-custom-class-currency-section {
  margin-bottom: 20px;
}

.bitlab-custom-class-currency-section-title {
  font-size: 13px;
  font-weight: 600;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 12px;
}

.bitlab-custom-class-currency{
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 16px;
  border-radius: 12px;
  margin-bottom: 8px;
  cursor: pointer;
  background: rgba(255,255,255,0.6);
  border: 1px solid rgba(0,0,0,0.05);
  transition: var(--transition);
  position: relative;
  overflow: hidden;
}

.bitlab-custom-class-currency::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  height: 100%;
  width: 3px;
  background: var(--primary);
  transform: scaleY(0);
  transition: var(--transition);
}

.bitlab-custom-class-currency:hover {
  background: rgba(255,255,255,0.8);
  transform: translateX(4px);
  box-shadow: var(--shadow-sm);
}

.bitlab-custom-class-currency.active{
  background: linear-gradient(135deg, rgba(11,116,255,0.1) 0%, rgba(11,116,255,0.05) 100%);
  border-color: var(--primary);
  box-shadow: 0 4px 12px rgba(11,116,255,0.15);
}

.bitlab-custom-class-currency.active::before {
  transform: scaleY(1);
}

.bitlab-custom-class-currency-info {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.bitlab-custom-class-code{
  font-weight: 700;
  font-size: 16px;
  color: var(--bitlab-navy);
  display: flex;
  align-items: center;
  gap: 8px;
}

.bitlab-custom-class-small{
  font-size: 12px;
  color: var(--muted);
  line-height: 1.4;
}

.bitlab-custom-class-currency-value {
  font-weight: 600;
  font-size: 15px;
  color: var(--bitlab-navy);
  min-width: 80px;
  text-align: right;
}

/* stats */
.bitlab-custom-class-stats{
  display: flex;
  flex-direction: column;
  gap: 12px;
  overflow-y: auto;
  max-height: 100%;
  scrollbar-width: thin;
  scrollbar-color: rgba(0,0,0,0.2) transparent;
  padding-right: 8px;
}

.bitlab-custom-class-stats::-webkit-scrollbar {
  width: 6px;
}

.bitlab-custom-class-stats::-webkit-scrollbar-track {
  background: transparent;
}

.bitlab-custom-class-stats::-webkit-scrollbar-thumb {
  background: rgba(0,0,0,0.2);
  border-radius: 3px;
}

.bitlab-custom-class-statcard{
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  padding: 16px;
  border-radius: 12px;
  background: rgba(255,255,255,0.7);
  box-shadow: var(--shadow-sm);
  border: 1px solid rgba(0,0,0,0.05);
  transition: var(--transition);
}

.bitlab-custom-class-statcard:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
  background: rgba(255,255,255,0.85);
}

.bitlab-custom-class-statleft{
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.bitlab-custom-class-statlabel{
  font-size: 12px;
  color: var(--muted);
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.bitlab-custom-class-statvalue{
  font-weight: 700;
  font-size: 20px;
  color: var(--bitlab-navy);
  line-height: 1.2;
}

.bitlab-custom-class-statright {
  display: flex;
  flex-direction: column;
  gap: 4px;
  text-align: right;
}

.bitlab-custom-class-stat-metric {
  font-size: 11px;
  color: var(--muted);
  line-height: 1.4;
}

/* footer */
.bitlab-custom-class-footer{
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 24px;
  padding-top: 20px;
  border-top: 1px solid rgba(0,0,0,0.1);
  color: var(--muted);
  font-size: 13px;
  flex-wrap: wrap;
  gap: 12px;
}

/* chart container */
.bitlab-custom-class-chartwrap{
  height: 100%;
  min-height: 420px;
  padding: 20px;
  border-radius: 12px;
  background: rgba(255,255,255,0.5);
  box-shadow: inset 0 2px 8px rgba(0,0,0,0.05);
  border: 1px solid rgba(0,0,0,0.05);
}

/* legend */
.bitlab-custom-class-legend {
  margin-top: 20px;
  padding-top: 20px;
  border-top: 1px solid rgba(0,0,0,0.1);
}

.bitlab-custom-class-legend-title {
  font-size: 12px;
  font-weight: 600;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 8px;
}

.bitlab-custom-class-legend-text {
  font-size: 12px;
  color: var(--muted);
  line-height: 1.6;
}

/* links */
a.bitlab-custom-class-link{
  color: var(--primary);
  text-decoration: none;
  font-weight: 600;
  transition: var(--transition);
  border-bottom: 1px solid transparent;
}

a.bitlab-custom-class-link:hover {
  border-bottom-color: var(--primary);
}

/* mobile responsive */
@media (max-width: 1024px) {
  .bitlab-custom-class-grid {
    grid-template-columns: 1fr;
  }
  
  .bitlab-custom-class-main-content {
    grid-template-columns: 1fr;
    gap: 20px;
  }
  
  .bitlab-custom-class-side {
    max-height: none;
    order: 2;
  }
  
  .bitlab-custom-class-main {
    order: 1;
  }
  
  .bitlab-custom-class-chartwrap {
    height: 360px;
    min-height: 360px;
  }
  
  .bitlab-custom-class-stats {
    max-height: none;
  }
}

@media (max-width: 768px) {
  .bitlab-custom-class-app {
    padding: 16px;
  }
  
  .bitlab-custom-class-top {
    padding: 16px;
    flex-direction: column;
    align-items: stretch;
  }
  
  .bitlab-custom-class-brand {
    margin-bottom: 12px;
  }
  
  .bitlab-custom-class-controls {
    width: 100%;
    justify-content: stretch;
  }
  
  .bitlab-custom-class-control-group {
    flex: 1;
    justify-content: center;
  }
  
  .bitlab-custom-class-btn {
    flex: 1;
    min-width: 120px;
  }
  
  .bitlab-custom-class-title {
    font-size: 20px;
  }
  
  .bitlab-custom-class-side {
    padding: 20px;
  }
  
  .bitlab-custom-class-main {
    padding: 20px;
  }
  
  .bitlab-custom-class-main-content {
    grid-template-columns: 1fr;
    gap: 20px;
  }
  
  .bitlab-custom-class-chartwrap {
    height: 320px;
    min-height: 320px;
    padding: 16px;
  }
  
  .bitlab-custom-class-stats {
    max-height: none;
  }
  
  .bitlab-custom-class-footer {
    flex-direction: column;
    text-align: center;
    align-items: center;
  }
}

@media (max-width: 480px) {
  .bitlab-custom-class-app {
    padding: 12px;
  }
  
  .bitlab-custom-class-top {
    padding: 12px;
  }
  
  .bitlab-custom-class-logo {
    width: 48px;
    height: 48px;
    font-size: 18px;
  }
  
  .bitlab-custom-class-title {
    font-size: 18px;
  }
  
  .bitlab-custom-class-sub {
    font-size: 12px;
  }
  
  .bitlab-custom-class-controls {
    flex-direction: column;
    gap: 8px;
  }
  
  .bitlab-custom-class-control-group {
    width: 100%;
  }
  
  .bitlab-custom-class-input {
    flex: 1;
  }
  
  .bitlab-custom-class-btn {
    width: 100%;
  }
  
  .bitlab-custom-class-side {
    padding: 16px;
  }
  
  .bitlab-custom-class-main {
    padding: 16px;
  }
  
  .bitlab-custom-class-main-content {
    grid-template-columns: 1fr;
    gap: 16px;
  }
  
  .bitlab-custom-class-chartwrap {
    height: 280px;
    min-height: 280px;
    padding: 12px;
  }
  
  .bitlab-custom-class-stats {
    max-height: none;
  }
  
  .bitlab-custom-class-currency {
    padding: 12px;
  }
  
  .bitlab-custom-class-statcard {
    padding: 14px;
    flex-direction: column;
    gap: 12px;
  }
  
  .bitlab-custom-class-statright {
    text-align: left;
    width: 100%;
  }
}

/* animations */
@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.bitlab-custom-class-currency,
.bitlab-custom-class-statcard {
  animation: fadeIn 0.3s ease-out;
}

/* print styles */
@media print {
  .bitlab-custom-class-controls,
  .bitlab-custom-class-footer {
    display: none;
  }
  
  .bitlab-custom-class-grid {
    grid-template-columns: 1fr;
  }
}
</style>
</head>
<body>
<div class="bitlab-custom-class-app" id="app">
  <div class="bitlab-custom-class-top">
    <div class="bitlab-custom-class-brand">
      <div class="bitlab-custom-class-logo">BL</div>
      <div>
        <div class="bitlab-custom-class-title">Exchange Rate Dashboard</div>
        <div class="bitlab-custom-class-sub">TTBUY history â€” data source: <a class="bitlab-custom-class-link" href="https://www.sampath.lk/rates-and-charges?activeTab=exchange-rates" target="_blank" rel="noopener">Sampath Bank â€” Exchange Rates</a></div>
      </div>
    </div>

    <div class="bitlab-custom-class-controls">
      <div class="bitlab-custom-class-control-group">
        <label class="bitlab-custom-class-small" for="daysInput">Days</label>
        <input id="daysInput" class="bitlab-custom-class-input" type="number" min="1" max="365" value="14">
      </div>
      <div class="bitlab-custom-class-control-group">
        <label class="bitlab-custom-class-small" for="viewSelect">View</label>
        <select id="viewSelect" class="bitlab-custom-class-input">
          <option value="days">Last N days</option>
          <option value="monthly">Monthly</option>
        </select>
      </div>
      <button id="exportCsv" class="bitlab-custom-class-btn">Export CSV</button>
      <button id="darkToggle" class="bitlab-custom-class-btn bitlab-custom-class-btn-secondary">ðŸŒ™ Dark</button>
    </div>
  </div>

  <div class="bitlab-custom-class-grid">
    <div class="bitlab-custom-class-side">
      <div class="bitlab-custom-class-currency-section">
        <div class="bitlab-custom-class-currency-section-title">Currencies</div>
        <div id="currencyList"></div>
      </div>

      <div class="bitlab-custom-class-legend">
        <div class="bitlab-custom-class-legend-title">Legend</div>
        <div class="bitlab-custom-class-legend-text">â†‘ increasing Â· â†“ decreasing Â· â†’ unchanged</div>
      </div>
    </div>

    <div class="bitlab-custom-class-main">
      <div class="bitlab-custom-class-main-content">
        <div class="bitlab-custom-class-chartwrap">
          <canvas id="rateChart" height="360"></canvas>
        </div>

        <div class="bitlab-custom-class-stats" id="statsArea" aria-live="polite"></div>
      </div>

      <div class="bitlab-custom-class-footer">
        <div>Developed by Chavindu Nuwanpriya Â© <span id="footer-year"></span></div>
        <div class="bitlab-custom-class-small">Data source: <a class="bitlab-custom-class-link" href="https://www.sampath.lk/rates-and-charges?activeTab=exchange-rates" target="_blank" rel="noopener">sampath.lk</a></div>
      </div>
    </div>
  </div>
</div>

<script>
/* Dashboard script (uses Chart.js). Uses files at public/data/<code>.json and public/data/manifest.json */
const ctx = document.getElementById('rateChart').getContext('2d');
let chart;
const manifestPath = 'data/manifest.json';
const maxPoints = 365;

// DOM
const currencyList = document.getElementById('currencyList');
const daysInput = document.getElementById('daysInput');
const viewSelect = document.getElementById('viewSelect');
const exportCsvBtn = document.getElementById('exportCsv');
const darkToggle = document.getElementById('darkToggle');
const statsArea = document.getElementById('statsArea');

// Auto-update footer year
const footerYear = document.getElementById('footer-year');
if (footerYear) footerYear.textContent = new Date().getFullYear();

let manifest = [];
let dataCache = {};
let selected = [];

// helpers
const parseNum = v => (typeof v === 'string') ? parseFloat(v.replace(/,/g,'')) : Number(v);
const fmt = n => (Math.round(n*1000)/1000).toLocaleString('en-US');

function signArrow(arr){
  if(!arr || arr.length < 2) return 'â†’';
  const last = arr[arr.length-1].value;
  const prev = arr[arr.length-2].value;
  if(last > prev) return 'â†‘';
  if(last < prev) return 'â†“';
  return 'â†’';
}
function pct(prev,last){
  if(prev === 0 || prev == null || last == null) return null;
  return ((last - prev)/prev)*100;
}

// load manifest
async function loadManifest(){
  try{
    const r = await fetch(manifestPath);
    manifest = await r.json();
  }catch(e){
    manifest = ['USD','GBP'];
  }
  renderCurrencyList();
  // Load data for all currencies to show last values
  await ensureData(manifest);
  // Update last values for all currencies
  updateAllLastValues();
  // default select first two
  selected = manifest.slice(0,2);
  selected.forEach(code => {
    const el = document.querySelector('[data-code="'+code+'"]');
    if(el) el.classList.add('active');
  });
  updateAll();
}

function renderCurrencyList(){
  currencyList.innerHTML = '';
  manifest.forEach(code=>{
    const el = document.createElement('div');
    el.className = 'bitlab-custom-class-currency';
    el.setAttribute('data-code', code);
    el.innerHTML = `
      <div class="bitlab-custom-class-currency-info">
        <div class="bitlab-custom-class-code">${code}</div>
        <div class="bitlab-custom-class-small">TTBUY Rate</div>
      </div>
      <div class="bitlab-custom-class-currency-value" id="last-${code}">â€”</div>
    `;
    el.onclick = ()=> toggleCode(code, el);
    currencyList.appendChild(el);
  });
}

async function ensureData(codes){
  await Promise.all(codes.map(async code=>{
    if(!dataCache[code]){
      try{
        const r = await fetch(`data/${code.toLowerCase()}.json`);
        if(!r.ok) throw new Error(`HTTP ${r.status}`);
        const arr = await r.json();
        // Handle both array format and ensure it's an array
        const dataArray = Array.isArray(arr) ? arr : [];
        dataCache[code] = dataArray
          .filter(x => x && x.date && x.value != null)
          .map(x=>({date:x.date,value:parseNum(x.value)}));
      }catch(e){
        console.warn(`Failed to load data for ${code}:`, e);
        dataCache[code] = [];
      }
    }
  }));
}

function toggleCode(code, el){
  if(selected.includes(code)){
    selected = selected.filter(c=>c!==code);
    el.classList.remove('active');
  } else {
    selected.push(code);
    el.classList.add('active');
  }
  ensureData([code]).then(()=>{
    updateAllLastValues();
    updateAll();
  });
}

function getRange(arr, days, view){
  if(!arr) return [];
  if(view === 'monthly'){
    const map = {};
    arr.forEach(it=>{
      const m = it.date.slice(0,7);
      if(!map[m]) map[m]=[];
      map[m].push(it.value);
    });
    const out = Object.keys(map).sort().map(k=>{
      const v = map[k];
      const avg = v.reduce((a,b)=>a+b,0)/v.length;
      return {date: k+'-01', value: avg};
    });
    return out.slice(-days);
  } else {
    return arr.slice(-days);
  }
}

function computeStats(arr){
  if(!arr || arr.length===0) return null;
  const vals = arr.map(x=>x.value);
  const min = Math.min(...vals);
  const max = Math.max(...vals);
  const avg = vals.reduce((a,b)=>a+b,0)/vals.length;
  return {min,max,avg};
}

function buildDatasets(days, view){
  const labelsSet = new Set();
  const series = [];
  // Only process selected currencies that have data
  const selectedWithData = selected.filter(code => {
    const arr = dataCache[code] || [];
    return arr.length > 0;
  });
  
  selectedWithData.forEach(code=>{
    const arr = getRange(dataCache[code]||[], days, view);
    arr.forEach(r=>labelsSet.add(r.date));
  });
  const labels = Array.from(labelsSet).sort();
  
  selectedWithData.forEach(code=>{
    const arr = getRange(dataCache[code]||[], days, view);
    const map = new Map(arr.map(x=>[x.date,x.value]));
    const data = labels.map(d => map.has(d) ? map.get(d) : null);
    series.push({label:code,data,tension:0.25,borderWidth:2,spanGaps:true});
  });
  
  // If no data available, return empty structure
  if(labels.length === 0){
    return {labels: [], series: []};
  }
  
  return {labels,series};
}

// Update last values for all currencies in the list
function updateAllLastValues(){
  manifest.forEach(code=>{
    const arr = dataCache[code] || [];
    const last = arr.length ? arr[arr.length-1].value : null;
    const lastEl = document.getElementById('last-'+code);
    if(lastEl) lastEl.textContent = last!=null?fmt(last):'â€”';
  });
}

function updateStats(days, view){
  statsArea.innerHTML = '';
  selected.forEach(code=>{
    const arr = getRange(dataCache[code]||[], days, view);
    const stats = computeStats(arr);
    const arrow = signArrow(arr);
    const last = arr.length ? arr[arr.length-1].value : null;
    const prev = arr.length>1 ? arr[arr.length-2].value : null;
    const change = (last!=null && prev!=null) ? pct(prev,last) : null;

    const el = document.createElement('div');
    el.className = 'bitlab-custom-class-statcard';
    const changeColor = change != null ? (change > 0 ? 'var(--success)' : change < 0 ? 'var(--danger)' : 'var(--muted)') : 'var(--muted)';
    el.innerHTML = `
      <div class="bitlab-custom-class-statleft">
        <div class="bitlab-custom-class-statlabel">${code} ${arrow}</div>
        <div class="bitlab-custom-class-statvalue">${last!=null?fmt(last):'â€”'}</div>
      </div>
      <div class="bitlab-custom-class-statright">
        <div class="bitlab-custom-class-stat-metric">Min: ${stats?fmt(stats.min):'â€”'}</div>
        <div class="bitlab-custom-class-stat-metric">Max: ${stats?fmt(stats.max):'â€”'}</div>
        <div class="bitlab-custom-class-stat-metric">Avg: ${stats?fmt(stats.avg):'â€”'}</div>
        <div class="bitlab-custom-class-stat-metric" style="color: ${changeColor}; font-weight: 600;">Î” ${change!=null?change.toFixed(2)+'%':'â€”'}</div>
      </div>
    `;
    statsArea.appendChild(el);

    // update last value in list
    const lastEl = document.getElementById('last-'+code);
    if(lastEl) lastEl.textContent = last!=null?fmt(last):'â€”';
  });
}

function getThemeColors() {
  const isDark = document.documentElement.classList.contains('bitlab-custom-class-dark-theme');
  return {
    isDark,
    text: isDark ? '#f1f5f9' : '#00134D',
    muted: isDark ? '#94a3b8' : '#6b7280',
    grid: isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)',
    tooltipBg: isDark ? 'rgba(15,23,42,0.95)' : 'rgba(255,255,255,0.95)',
    tooltipBorder: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'
  };
}

function createChart(labels, series){
  if(chart) chart.destroy();
  
  // Handle empty data case
  if(!labels || labels.length === 0 || !series || series.length === 0){
    chart = new Chart(ctx, {
      type:'line',
      data:{labels: [], datasets: []},
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{
          legend:{display:false},
          tooltip:{enabled:false}
        },
        scales:{x:{display:false}, y:{display:false}}
      }
    });
    return;
  }
  
  const theme = getThemeColors();
  
  // Generate colors for datasets
  const colors = [
    { border: '#0b74ff', background: 'rgba(11,116,255,0.1)' },
    { border: '#10b981', background: 'rgba(16,185,129,0.1)' },
    { border: '#f59e0b', background: 'rgba(245,158,11,0.1)' },
    { border: '#ef4444', background: 'rgba(239,68,68,0.1)' },
    { border: '#8b5cf6', background: 'rgba(139,92,246,0.1)' },
    { border: '#ec4899', background: 'rgba(236,72,153,0.1)' },
    { border: '#06b6d4', background: 'rgba(6,182,212,0.1)' },
    { border: '#84cc16', background: 'rgba(132,204,22,0.1)' },
    { border: '#f97316', background: 'rgba(249,115,22,0.1)' },
    { border: '#6366f1', background: 'rgba(99,102,241,0.1)' },
    { border: '#14b8a6', background: 'rgba(20,184,166,0.1)' }
  ];
  
  const datasets = series.map((s, i) => ({
    ...s,
    borderColor: colors[i % colors.length].border,
    backgroundColor: colors[i % colors.length].background,
    fill: false,
    pointRadius: 3,
    pointHoverRadius: 6,
    pointBackgroundColor: colors[i % colors.length].border,
    pointBorderColor: theme.isDark ? '#0f172a' : '#fff',
    pointBorderWidth: 2
  }));
  
  chart = new Chart(ctx, {
    type:'line',
    data:{labels, datasets},
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        zoom:{
          pan:{enabled:true,mode:'x'},
          zoom:{
            wheel:{enabled:true},
            pinch:{enabled:true},
            mode:'x'
          }
        },
        legend:{
          position:'top',
          labels:{
            usePointStyle: true,
            padding: 15,
            font: { size: 12, weight: '500' },
            color: theme.text
          }
        },
        tooltip: {
          backgroundColor: theme.tooltipBg,
          titleColor: theme.text,
          bodyColor: theme.text,
          borderColor: theme.tooltipBorder,
          borderWidth: 1,
          padding: 12,
          displayColors: true,
          callbacks: {
            label: function(context) {
              return context.dataset.label + ': ' + fmt(context.parsed.y);
            }
          }
        }
      },
      interaction:{mode:'index',intersect:false},
      scales:{
        x:{
          display:true,
          grid: {
            color: theme.grid,
            drawBorder: false
          },
          ticks: {
            font: { size: 11 },
            color: theme.muted
          }
        },
        y:{
          display:true,
          grid: {
            color: theme.grid,
            drawBorder: false
          },
          ticks: {
            font: { size: 11 },
            color: theme.muted,
            callback: function(value) {
              return fmt(value);
            }
          }
        }
      }
    }
  });
}

function updateAll(){
  const days = Math.min(Math.max(1,parseInt(daysInput.value||14)), maxPoints);
  const view = viewSelect.value;
  ensureData(selected).then(()=>{
    const {labels, series} = buildDatasets(days, view);
    createChart(labels, series);
    updateStats(days, view);
  });
}

function exportCSV(){
  if(!chart) return alert('No data');
  const labels = chart.data.labels;
  const rows = [['date', ...chart.data.datasets.map(ds=>ds.label)]];
  for(let i=0;i<labels.length;i++){
    const row = [labels[i]];
    for(const ds of chart.data.datasets) row.push(ds.data[i] ?? '');
    rows.push(row);
  }
  const csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download=`rates_${new Date().toISOString().slice(0,10)}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

// events
daysInput.addEventListener('change', updateAll);
viewSelect.addEventListener('change', updateAll);
exportCsvBtn.addEventListener('click', exportCSV);
darkToggle.addEventListener('click', ()=> {
  document.documentElement.classList.toggle('bitlab-custom-class-dark-theme');
  const isDark = document.documentElement.classList.contains('bitlab-custom-class-dark-theme');
  darkToggle.textContent = isDark ? 'â˜€ï¸ Light' : 'ðŸŒ™ Dark';
  // Update chart if it exists
  if(chart && selected.length > 0) {
    updateAll();
  }
});

// init
loadManifest();
</script>
</body>
</html>
